# ===========================================
# CONFIGURATION APACHE COMPLETE - ALLADSMARKET
# Version optimisee et securisee pour production
# ===========================================

# ===========================================
# CONFIGURATION DE BASE
# ===========================================

# Activer le moteur de reecriture
RewriteEngine On
RewriteBase /

# ===========================================
# REDIRECTIONS HTTPS ET WWW
# ===========================================

# Force HTTPS pour alladsmarket.com
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} ^(www\.)?alladsmarket\.com$ [NC]
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Force www (optionnel - decommentez si necessaire)
# RewriteCond %{HTTP_HOST} ^alladsmarket\.com$ [NC]
# RewriteRule ^(.*)$ https://www.alladsmarket.com/$1 [L,R=301]

# ===========================================
# SUPPORT REACT ROUTER (SPA)
# ===========================================

# Rediriger toutes les requetes vers index.html pour React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule . /index.html [L]

# ===========================================
# SECURITE AVANCEE
# ===========================================

# Desactiver la navigation dans les dossiers
Options -Indexes

# Protection contre les attaques par deni de service (mod_evasive)
<IfModule mod_evasive.c>
    DOSHashTableSize    2048
    DOSPageCount        20
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# ===========================================
# HEADERS DE SECURITE
# ===========================================

<IfModule mod_headers.c>
    # Protection contre le clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Protection contre le MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Note: X-XSS-Protection est obsolète et retiré pour compatibilité moderne
    
    # Politique de referent
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Politique de permissions
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
    
    # Protection Cross-Origin
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Resource-Policy "same-origin"
    
    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Content Security Policy (CSP)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://www.google-analytics.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: http: blob:; connect-src 'self' https://alladsmarket.com http://localhost:4000 https://www.google-analytics.com; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self';"
    
    # Supprimer les headers sensibles
    Header unset Server
    Header unset X-Powered-By
    Header unset X-AspNet-Version
    Header unset X-AspNetMvc-Version
    
    # CORS Headers (pour les appels API)
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
    Header always set Access-Control-Max-Age "86400"
    
    # Cache Control pour les fichiers statiques
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    # Cache Control pour HTML
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600"
    </FilesMatch>
</IfModule>

# ===========================================
# COMPRESSION ET PERFORMANCE
# ===========================================

# Compression Gzip
<IfModule mod_deflate.c>
    # Compresser les fichiers texte
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml application/rss+xml application/atom+xml image/svg+xml
    
    # Compresser les polices
    AddOutputFilterByType DEFLATE font/truetype font/opentype application/vnd.ms-fontobject application/x-font-woff
    
    # Exclure les fichiers deja compresses
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|rar|zip|exe|flv|mov|wma|mp3|avi|swf|mp?g|mp4|webm|webp|pdf)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# ===========================================
# CACHE NAVIGATEUR
# ===========================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/bmp "access plus 1 year"
    ExpiresByType image/tiff "access plus 1 year"
    
    # CSS et JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Polices
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
    
    # Manifest et autres
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
    
    # Documents
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    
    # XML
    ExpiresByType text/xml "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType application/atom+xml "access plus 1 hour"
    ExpiresByType application/rss+xml "access plus 1 hour"
</IfModule>

# ===========================================
# PROTECTION DES FICHIERS SENSIBLES
# ===========================================

# Proteger les fichiers sensibles
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|env|json|md|bak|backup|old|tmp|temp)$">
    Require all denied
</FilesMatch>

# Proteger les fichiers de configuration
<FilesMatch "^(\.env|\.env\.local|\.env\.production|\.env\.development|config\.js|config\.json)$">
    Require all denied
</FilesMatch>

# Proteger les fichiers de base de donnees
<FilesMatch "\.(db|sqlite|sqlite3)$">
    Require all denied
</FilesMatch>

# Autoriser les fichiers publics specifiques
<FilesMatch "^(manifest\.json|robots\.txt|sitemap\.xml|sitemap-index\.xml|sitemap-images\.xml|sitemap-news\.xml|favicon\.ico|favicon\.svg)$">
    Require all granted
</FilesMatch>

# ===========================================
# PROTECTION DES DOSSIERS SYSTEME
# ===========================================

# Proteger node_modules
RedirectMatch 404 /node_modules/

# Proteger .git
RedirectMatch 404 /\.git

# Proteger les dossiers de developpement
RedirectMatch 404 /src/
RedirectMatch 404 /scripts/
RedirectMatch 404 /docs/

# Proteger les fichiers de sauvegarde
RedirectMatch 404 /\..*\.swp$
RedirectMatch 404 /\..*\.swo$
RedirectMatch 404 /.*\.bak$
RedirectMatch 404 /.*\.backup$

# ===========================================
# OPTIMISATION SEO
# ===========================================

# Redirection des URLs sans trailing slash vers avec trailing slash
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} !(.*)/$
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1/ [L,R=301]

# Redirection des URLs avec double slash
RewriteCond %{THE_REQUEST} \s[^?]*//
RewriteRule ^(.*)$ /$1 [R=301,L]

# ===========================================
# OPTIMISATION MOBILE
# ===========================================

# Detection mobile et redirection (optionnel)
# RewriteCond %{HTTP_USER_AGENT} "android|blackberry|iphone|ipod|iemobile|opera mobile|palmos|webos|googlebot-mobile" [NC]
# RewriteRule ^(.*)$ /mobile/$1 [R=302,L]

# ===========================================
# GESTION DES ERREURS
# ===========================================

# Pages d'erreur personnalisees
ErrorDocument 400 /error.html
ErrorDocument 401 /error.html
ErrorDocument 403 /error.html
ErrorDocument 404 /error.html
ErrorDocument 500 /error.html
ErrorDocument 502 /error.html
ErrorDocument 503 /error.html
ErrorDocument 504 /error.html

# ===========================================
# CONFIGURATION AVANCEE
# ===========================================

# Limiter la taille des fichiers uploades
LimitRequestBody 10485760

# Desactiver le serveur signature
ServerTokens Prod

# Timeout pour les connexions
Timeout 300

# ===========================================
# MONITORING ET LOGS
# ===========================================

# Logs d'acces personnalises
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog logs/access.log combined

# Logs d'erreur
ErrorLog logs/error.log
LogLevel warn

# ===========================================
# CONFIGURATION SPECIFIQUE ALLADSMARKET
# ===========================================

# Redirection des anciennes URLs (si necessaire)
# RewriteRule ^old-page/?$ /new-page/ [R=301,L]

# Gestion des parametres d'URL
RewriteCond %{QUERY_STRING} ^(.*)$
RewriteRule ^(.*)$ - [E=QUERY_STRING:%1]

# ===========================================
# FIN DE CONFIGURATION
# ===========================================

# Configuration optimisee pour AllAdsMarket
# Version: 2.0
# Date: 2025-01-27
# Compatible: Apache 2.4+
# Optimise pour: React SPA, SEO, Performance, Securite