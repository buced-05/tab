# ============================================
# Configuration Nginx BULLETPROOF pour AllAdsMarket
# Garantit que TOUS les slugs et liens partagés fonctionnent
# ============================================

# Redirection HTTP vers HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name alladsmarket.com www.alladsmarket.com;

    # Redirection permanente vers HTTPS
    return 301 https://$host$request_uri;
}

# Serveur HTTPS principal
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name alladsmarket.com www.alladsmarket.com;

    # ============================================
    # SSL/TLS Configuration
    # ============================================
    ssl_certificate /etc/letsencrypt/live/alladsmarket.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/alladsmarket.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ============================================
    # Répertoire racine et index
    # ============================================
    root /var/www/alladsmarket/dist;
    index index.html;

    # ============================================
    # Compression Gzip
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_comp_level 6;
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/xml 
        application/xml+rss 
        image/svg+xml
        application/manifest+json;

    # ============================================
    # PRIORITÉ 1: Fichiers statiques réels
    # DOIT être AVANT les routes SPA pour éviter de servir index.html
    # ============================================

    # Assets JS - CRITIQUE: Doit retourner 404 si non trouvé, PAS index.html
    location ~* ^/assets/js/.*\.(js|jsx|mjs)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "application/javascript; charset=utf-8" always;
        access_log off;
        try_files $uri =404;
    }

    # Assets CSS
    location ~* ^/assets/css/.*\.css$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "text/css; charset=utf-8" always;
        access_log off;
        try_files $uri =404;
    }

    # Images et médias
    location ~* ^/assets/.*\.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif|mp4|webm)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # Dossier assets complet (fallback pour autres fichiers)
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # ============================================
    # PRIORITÉ 2: Fichiers spécifiques à la racine
    # ============================================

    # Fichiers JS à la racine (si existent)
    location ~* ^/[^/]+\.(js|jsx|mjs)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "application/javascript; charset=utf-8" always;
        try_files $uri =404;
    }

    # Fichiers CSS à la racine
    location ~* ^/[^/]+\.css$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "text/css; charset=utf-8" always;
        try_files $uri =404;
    }

    # Images à la racine (logo, favicon, etc.)
    location ~* ^/[^/]+\.(png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # Manifest et fichiers JSON
    location ~* ^/(manifest|robots|seo-report)\.(json|txt)$ {
        expires 1h;
        add_header Cache-Control "public";
        add_header Content-Type "application/json; charset=utf-8" always;
        try_files $uri =404;
    }

    # Service Worker
    location = /sw.js {
        expires 0;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Content-Type "application/javascript; charset=utf-8" always;
        try_files $uri =404;
    }

    # ============================================
    # PRIORITÉ 3: Sitemaps (doivent être accessibles)
    # ============================================
    location ~* ^/sitemap.*\.xml$ {
        expires 1h;
        add_header Cache-Control "public";
        add_header Content-Type "application/xml; charset=utf-8" always;
        try_files $uri =404;
    }

    # Sitemap principal (sans extension)
    location = /sitemap.xml {
        expires 1h;
        add_header Cache-Control "public";
        add_header Content-Type "application/xml; charset=utf-8" always;
        try_files $uri =404;
    }

    # ============================================
    # PRIORITÉ 4: Fichiers dans dossiers spécifiques
    # ============================================

    # Images dans le dossier images/
    location /images/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # ============================================
    # PRIORITÉ 5: Routes API (désactivées - pas de backend)
    # ============================================
    # Les routes API sont désactivées car il n'y a plus de backend Django
    # location /api/ {
    #     return 404;
    # }

    # ============================================
    # PRIORITÉ 6: Routes React SPA (DERNIÈRE PRIORITÉ)
    # Toutes les routes qui ne correspondent pas aux fichiers statiques
    # ============================================

    # Routes spécifiques pour produits et articles (priorité)
    location ~* ^/(products|ai-article|article|revolutionary-blog|articles|ai-articles)/ {
        try_files $uri $uri/ /index.html;
    }

    # Index.html - NO CACHE pour permettre les mises à jour
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }

    # Toutes les autres routes - SPA routing
    location / {
        # Essayer d'abord le fichier exact, puis avec trailing slash, puis index.html
        try_files $uri $uri/ /index.html;
    }

    # ============================================
    # Health Check
    # ============================================
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type "text/plain";
    }

    # ============================================
    # Sécurité : Bloquer l'accès aux fichiers sensibles
    # ============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~* \.(env|git|svn|htaccess|htpasswd)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ============================================
    # Logs
    # ============================================
    access_log /var/log/nginx/alladsmarket.access.log;
    error_log  /var/log/nginx/alladsmarket.error.log warn;

    # ============================================
    # Robots.txt (doit être accessible)
    # ============================================
    location = /robots.txt {
        expires 1h;
        add_header Cache-Control "public";
        add_header Content-Type "text/plain; charset=utf-8" always;
        add_header X-Robots-Tag "index, follow" always;
        try_files $uri =404;
    }

    # ============================================
    # Headers de sécurité et indexation
    # ============================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Headers pour permettre l'indexation (sauf pour les pages d'erreur)
    # Note: Les pages individuelles peuvent override avec leurs propres meta tags
    add_header X-Robots-Tag "index, follow" always;
}
